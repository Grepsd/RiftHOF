{% extends 'base.html' %}
{% load humanize %}
{% load logparse_tpl_filters %}
{% block "content" %}
  <script type="text/javascript">
    if ({{ boss_id}} == 0)
    {
      setTimeout('document.location.reload()', 1000);
    };
    $(function () {
      var chart;
      $(document).ready(function() {
          $('.nav-tabs a:last').tab()
          $("#damages").tablesorter(); 
          $("#npc_table").tablesorter(); 
          chart = new Highcharts.Chart({
              chart: {
                  renderTo: 'dps_chart',
                  type: 'bar',
              },
              title: {
                  text: 'DPS Charts'
              },
              xAxis: {
                  categories: [{% for el in all_tops|dictsortreversed:"damages_value" %}{% if el.name != 'total' %}'{{ el.name|escapejs }}',{% endif %}{% endfor %}],
                  title: {
                      text: 'Player Name'
                  },
                  minPadding: 0.05,
              },

              yAxis: {
                  min: 0,
                  title: {
                      text: 'DPS',
                      align: 'high'
                  }
              },

              tooltip: {
                  formatter: function() {
                      return ''+
                          this.series.name +': '+ this.y;
                  }
              },

              plotOptions: {
                  bar: {
                      dataLabels: {
                          enabled: true
                      }
                  }
              },

              legend: {
                  layout: 'horizontal',
                  align: 'right',
                  verticalAlign: 'top',
                  x: -100,
                  y: 150,
                  floating: true,
                  borderWidth: 1,
                  backgroundColor: '#FFFFFF',
                  shadow: true
              },
              credits: {
                  enabled: false
              },
              series: [{
                  name: 'dps',
                  data: [{% for el in all_tops|dictsortreversed:"damages_value" %}{% if el.name != 'total' %}{{ el.damages_by_time }},{% endif %}{% endfor %}],
              }]
          });
          chart = new Highcharts.Chart({
              chart: {
                  renderTo: 'hps_chart',
                  type: 'bar',
              },
              title: {
                  text: 'HPS Charts'
              },
              xAxis: {
                  categories: [{% for el in all_tops|dictsortreversed:"heals_value" %}{% if el.name != 'total' %}'{{ el.name|escapejs }}',{% endif %}{% endfor %}],
                  title: {
                      text: 'Player Name'
                  }
              },

              yAxis: {
                  min: 0,
                  title: {
                      text: 'HPS',
                      align: 'high'
                  }
              },

              tooltip: {
                  formatter: function() {
                      return ''+
                          this.series.name +': '+ this.y;
                  }
              },

              plotOptions: {
                  bar: {
                      dataLabels: {
                          enabled: true
                      }
                  }
              },

              legend: {
                  layout: 'horizontal',
                  align: 'right',
                  verticalAlign: 'top',
                  x: -100,
                  y: 150,
                  floating: true,
                  borderWidth: 1,
                  backgroundColor: '#FFFFFF',
                  shadow: true
              },
              credits: {
                  enabled: false
              },
              series: [{
                  name: 'hps',
                  data: [{% for el in all_tops|dictsortreversed:"heals_value" %}{% if el.name != 'total' %}{{ el.heals_by_time }},{% endif %}{% endfor %}],
              }]
          });
          chart = new Highcharts.Chart({
              chart: {
                  renderTo: 'taken_chart',
                  type: 'bar',
              },
              title: {
                  text: 'Damages Taken Charts'
              },
              xAxis: {
                  categories: [{% for el in all_tops|dictsortreversed:"taken_value" %}{% if el.name != 'total' %}'{{ el.name|escapejs }}',{% endif %}{% endfor %}],
                  title: {
                      text: 'Player Name'
                  }
              },

              yAxis: {
                  min: 0,
                  title: {
                      text: 'Damages Taken',
                      align: 'high'
                  }
              },

              tooltip: {
                  formatter: function() {
                      return ''+
                          this.series.name +': '+ this.y;
                  }
              },

              plotOptions: {
                  bar: {
                      dataLabels: {
                          enabled: true
                      }
                  }
              },

              legend: {
                  layout: 'horizontal',
                  align: 'right',
                  verticalAlign: 'top',
                  x: -100,
                  y: 150,
                  floating: true,
                  borderWidth: 1,
                  backgroundColor: '#FFFFFF',
                  shadow: true
              },
              credits: {
                  enabled: false
              },
              series: [{
                  name: 'taken',
                  data: [{% for el in all_tops|dictsortreversed:"taken_value" %}{% if el.name != 'total' %}{{ el.taken_by_time }},{% endif %}{% endfor %}],
              }]
          });        chart = new Highcharts.Chart({

          {% with timeline_list=timeline|dictsort:"time" %}
          chart: {
                renderTo: 'timeline',
                type: 'spline'
            },

            title: {
                text: 'Timeline'
            },
            xAxis: {
                categories: [{% for time in timeline_list %}'{{ time.time|secs }}',{% endfor %}],
                tickInterval: 6,
                plotBands: [
                  {% for buff in buffes %}
                    {
                      from: {{ buff.from }} / 5,
                      to:   {{ buff.to }} / 5,
                      color: '{% if buff.skill == "Couplet de joie" %}#CEF{% else %}#FEC{% endif %}',
                    },
                  {% endfor %}
                ],
                plotLines: [
                  {% for death in deathes %}
                    {
                        value : {{ death.time }} / 5,
                        color: '#A00',
                        width: 1,
                        label: {text: '{{ death.player }}',},
                    },
                  {% endfor %}
                  {% for r in rez %}
                    {
                        value : {{ r.time }} / 5,
                        color: '#0A0',
                        width: 1,
                        label: {text: '{{ r.player }}',},
                    },
                  {% endfor %}
                  ],
            },

            yAxis: {
                title: {
                    text: 'DPS/HPS'
                },
                labels: {
                    formatter: function() {
                        return this.value
                    }
                },
                min: 0,
            },

            tooltip: {
                crosshairs: true,
                shared: true
            },

            plotOptions: {
              spline: {
                marker: {
                  enabled: false,
                }
              }
            },



            series: [{
                name: 'DPS',
                data: [{% for stats in timeline_list %}{{ stats.total.players.done.hits }} / 5,{% endfor %}]
            }, {
                name: 'HPS',
                data: [{% for stats in timeline_list %}{{ stats.total.players.done.heals }} / 5,{% endfor %}]
            }, {
                name: 'Taken',
                data: [{% for stats in timeline_list %}{{ stats.total.players.received.hits }} / 5,{% endfor %}]
            }]
        });
      });
      {% endwith %}
      {% for stats in all_tops|dictsortreversed:"damages_original" %}
        $('#tooltip_{{ stats.name }}').popover({placement: 'bottom'{% if stats.name != 'total' %}, content: 'Name : {{ stats.name|escapejs }}<br /><table style="width: 100%;" class="table table-condensed table-bordered">' +
            '<thead>' +
              '<tr>' +
                '<th>Spell</th>' +
                '<th>Value</th>' +
                '<th>Ratio</th>' +
                '<th>Spell</th>' +
                '<th>Value</th>' +
                '<th>Ratio</th>' +
              '</tr>' +
            '</thead>' +
            '<tbody>' +
             '<th colspan=\"6\">Damages</th></tr>' +
          {% for skill in stats.damages_skills.done.hits|dictsortreversed:"value" %}
            {% if forloop.first %}
              {% cycle '' '\'</tr>\'+' %}
              '<tr>' +
            {% else %}
              {% cycle '\'</tr><tr>\'+' '' %}
            {% endif %}
              '<td>{{ skill.name|escapejs }}</td>' +
              '<td>{{ skill.value|intcomma }}</td>' +
              '<td>{{ skill.ratio|floatformat }}%</td>' +
            {% if forloop.last %}
              '</tr>' +
            {% endif %}
          {% endfor %}'<tr><th colspan=\"6\">Heals</th></tr>' +
          {% for skill in stats.heals_skills.done.heals|dictsortreversed:"value" %}
            {% if forloop.first %}
              {% cycle '' '\'</tr>\'+' %}
              '<tr>' +
            {% else %}
              {% cycle '\'</tr><tr>\'+' '' %}
            {% endif %}
              '<td>{{ skill.name|escapejs }}</td>' +
              '<td>{{ skill.value|intcomma }}</td>' +
              '<td>{{ skill.ratio|floatformat }}%</td>' +
            {% if forloop.last %}
              '</tr>' +
            {% endif %}
          {% endfor %}
             '</tbody>' +
            '</table>'{% endif %}});
      {% endfor %}
    });
    </script>
  <h2 class="center"><span class="{{ encounter.wipe|yesno:"icon-remove,icon-ok" }}"></span> <a href="{% url ranking_boss boss_id %}">{{ boss_name }}</a> [{{ encounter.stats.duration|secs }}]</h2>
  <!--
  <br /><br />
  <a href="{% url guild_log_show encounter.log.id %}"><span class="btn btn-success">< < Back</span></a>
  <br /><br />

  <div class="navbar">
    <div class="navbar-inner">
      <div class="container">
        <ul class="nav">
          <li><a href="#player_damages">Player Damages</a></li>
          <li class="divider-vertical"></li>
          <li><a href="#player_heals">Player Heals</a></li>
          <li class="divider-vertical"></li>
          <li><a href="#player_taken">Player Damages Taken</a></li>
          <li class="divider-vertical"></li>
          <li><a href="#npc_damages">NPC Damages</a></li>
          <li class="divider-vertical"></li>
          <li><a href="#npc_heals">NPC Heals</a></li>
          <li class="divider-vertical"></li>
          <li><a href="#npc_taken">NPC Damages Taken</a></li>
        </ul>
      </div>
    </div>
  </div>
  -->
  <a href="{% url guild_log_show encounter.log.id %}"><span class="btn btn-success">< < Back</span></a><br /><br />

  <ul class="nav nav-tabs">
    <li class="active"><a href="#timeline" data-toggle="tab">Timeline</a></li>
    <li><a href="#dps_chart" data-toggle="tab">DPS</a></li>
    <li><a href="#hps_chart" data-toggle="tab">HPS</a></li>
    <li><a href="#taken_chart" data-toggle="tab">Taken</a></li>
  </ul>

  <div class="tab-content">
    <div class="tab-pane active" id="timeline" style="min-width: 1100px;"></div>
    <div class="tab-pane" id="dps_chart" style="min-width: 1100px;"></div>
    <div class="tab-pane" id="hps_chart" style="min-width: 1100px;"></div>
    <div class="tab-pane" id="taken_chart" style="min-width: 1100px;"></div>
  </div>

  <br />
  <br />

  <ul class="nav nav-tabs">
    <li class="active"><a href="#players" data-toggle="tab">Players</a></li>
    <li><a href="#npcs" data-toggle="tab">NPCs</a></li>
    <li><a href="#life_and_death" data-toggle="tab">Life&Death</a></li>
  </ul>

  <div class="tab-content">
    <div class="tab-pane active" id="players" style="min-width: 1100px;">
      <table class="table table-condensed table-bordered tablesorter" id="damages">
        <thead>
          <tr>
            <th style="width: 10%;">Name</th>
            <th style="width: 10%;">Damages</th>
            <th style="width: 10%;">DPS</th>
            <th style="width: 10%;">% Dmg</th>
            <th style="width: 10%;">Heals</th>
            <th style="width: 10%;">HPS</th>
            <th style="width: 10%;">% heals</th>
            <th style="width: 10%;">Dmg taken</th>
            <th style="width: 10%;">DPS taken</th>
            <th style="width: 10%;">% taken</th>
          </tr>
        </thead>
        <tbody>
          {% for stats in all_tops|dictsortreversed:"damages_original" %}
            <tr id="tooltip_{{ stats.name }}">
              {% if stats.damages_id > 0 %}
                <td><a href="{% url actor_show_detail encounter.id stats.damages_id %}">{{ stats.name }}</a></td>
              {% else %}
                <td>{{ stats.name }}</td>
              {% endif %}
              <td>{{ stats.damages_original }}</td>
              <td>{{ stats.damages_by_time }}</td>
              <td>{{ stats.damages_ratio }}%</td>
              <td>{{ stats.heals_original }}</td>
              <td>{{ stats.heals_by_time }}</td>
              <td>{{ stats.heals_ratio }}%</td>
              <td>{{ stats.taken_original }}</td>
              <td>{{ stats.taken_by_time }}</td>
              <td>{{ stats.taken_ratio }}%</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="tab-pane" id="npcs" style="min-width: 1100px;">
      <table class="table table-condensed table-bordered tablesorter" id="npc_table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Total Dmg</th>
            <th>DPS</th>
            <th>% Dmg</th>
            <th>Total Heals</th>
            <th>HPS</th>
            <th>% heals</th>
            <th>Total Dms taken</th>
            <th>DPS taken</th>
            <th>% taken</th>
          </tr>
        </thead>
        <tbody>
          {% for stats in npc_all_tops|dictsortreversed:"damages_original" %}
            <tr>
              <td>{{ stats.name }}</td>
              <td>{{ stats.damages_original|intcomma }}</td>
              <td>{{ stats.damages_by_time|intcomma }}</td>
              <td>{{ stats.damages_ratio|intcomma }}%</td>
              <td>{{ stats.heals_original|intcomma }}</td>
              <td>{{ stats.heals_by_time|intcomma }}</td>
              <td>{{ stats.heals_ratio|intcomma }}%</td>
              <td>{{ stats.taken_original|intcomma }}</td>
              <td>{{ stats.taken_by_time|intcomma }}</td>
              <td>{{ stats.taken_ratio|intcomma }}%</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="tab-pane" id="life_and_death" style="min-width: 1100px;">
      {% for event in life_and_death|dictsort:"time" %}
        <span class="{% if event.type == 'death' %}error{% else %}success{% endif %}">{{ event.time|secs }} {{ event.player }}</span><br />
      {% endfor %}
    </div>
  </div>
  <a href="{% url guild_log_show encounter.log.id %}"><span class="btn btn-success">< < Back</span></a>
{% endblock %}